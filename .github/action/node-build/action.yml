name: Node build
description: 'Verify (lint, test) and build a node application'
inputs:
  NODE_VERSION:
    description: 'The version of Node.js to use'
    required: true
  SET_ENV:
    description: 'Whether to set the environment variables in a .env file'
    required: true
  ENVIRONMENT:
    description: 'The environment to deploy to (stage, prod)'
    required: true
  USE_CHROME:
    description: 'Whether to install chrome for testing'
    required: true
  VAULT_URL:
    required: true
    description: 'The URL of the Vault server'
  VAULT_SECRET_PATH:
    required: true
    description: 'The path to the secret in Vault'
  VAULT_ROLE_ID:
    required: true
    description: 'The role ID for the AppRole authentication method'
  VAULT_SECRET_ID:
    required: true
    description: 'The secret ID for the AppRole authentication method'

runs:
  using: 'composite'
  steps:
    - name: Install Google Chrome
      if: ${{ inputs.USE_CHROME == 'false' }}
      shell: bash
      continue-on-error: true
      env:
        HELPER_SCRIPTS: ./helpers
        TEST_SCRIPTS: ./tests
      run: |
        # Add universe repository to install Google Chrome's dependencies
        sudo add-apt-repository universe
        sudo apt-get update
        sudo apt-get upgrade -y
        # Install Githubs action runner official helper scripts
        mkdir helpers
        curl -s https://api.github.com/repos/actions/runner-images/contents/images/ubuntu/scripts/helpers | jq -r '.[].download_url' | while read url; do
          wget -P helpers "$url"
        done
        # Install Githubs action runner official test scripts
        mkdir tests
        curl -s https://api.github.com/repos/actions/runner-images/contents/images/ubuntu/scripts/tests | jq -r '.[].download_url' | while read url; do
          wget -P tests "$url"
        done
        # Replace $HELPER_SCRIPTS with the actual path in the helper scripts
        for file in helpers/*; do
          sed -i "s|\$HELPER_SCRIPTS|${HELPER_SCRIPTS}|g" "$file"
        done
        # Download the install Github runners Google Chrome install script and run
        wget -qO- https://raw.githubusercontent.com/actions/runner-images/refs/heads/main/images/ubuntu/scripts/build/install-google-chrome.sh | \
          sed "s|\$HELPER_SCRIPTS|${HELPER_SCRIPTS}|g" | \
          sed "s|apt-get install|apt-get install -y|g" | \
          sudo bash

    - name: install chrome dependencies
      shell: bash
      if: ${{ inputs.USE_CHROME == 'true' }}
      run: |
        sudo apt-get update
        wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
        sudo apt-get install -y -f ./google-chrome-stable_current_amd64.deb

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.NODE_VERSION }}
        cache: "npm"

    - name: Install dependencies
      shell: bash
      run: npm install

    - name: Linting
      shell: bash
      run: npm run lint

    - name: Create .env
      if: ${{ inputs.SET_ENV == 'true' }}
      uses: NationalLibraryOfNorway/tekst-workflows/.github/action/write-env-file-from-vault@ci/chrome-test
      with:
        ENVIRONMENT: ${{ inputs.ENVIRONMENT }}
        VAULT_URL: ${{ inputs.VAULT_URL }}
        VAULT_SECRET_PATH: ${{ inputs.VAULT_SECRET_PATH }}
        VAULT_ROLE_ID: ${{ inputs.VAULT_ROLE_ID }}
        VAULT_SECRET_ID: ${{ inputs.VAULT_SECRET_ID }}

    - name: Run unit tests
      shell: bash
      run: npm run test:ci

    - name: Build application
      shell: bash
      run: npm run build:${{ inputs.ENVIRONMENT }}