name: Node check

on:
  workflow_call:
    inputs:
      ENVIRONMENT:
        required: true
        description: "The environment to deploy to (stage, prod)"
        type: string
      NODE_VERSION:
        required: true
        description: "The version of Node.js to use"
        type: string
      BUILD_OUTPUT_PATH:
        required: true
        description: "The path to the build output, e.g. .next or dist"
        type: string
      SET_ENV:
        required: true
        description: "Whether to set the environment variables in a .env.production file"
        type: boolean
    secrets:
      VAULT_URL:
        required: true
      VAULT_SECRET_PATH:
        required: true
      VAULT_ROLE_ID:
        required: true
      VAULT_SECRET_ID:
        required: true

jobs:
  node-verify:
    runs-on: [self-hosted-linux]
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Linting
        run: npm run lint

      - name: Set REPOSITORY_NAME
        if: ${{ inputs.SET_ENV == true }}
        uses: NationalLibraryOfNorway/tekst-workflows/.github/action/set-repo-name@main

      - name: Import secrets
        id: import-secrets
        if: ${{ inputs.SET_ENV == true }}
        uses: hashicorp/vault-action@v3
        with:
          url: ${{ secrets.VAULT_URL }}
          method: approle
          roleId: ${{ secrets.VAULT_ROLE_ID }}
          secretId: ${{ secrets.VAULT_SECRET_ID }}
          secrets: |
            ${{ secrets.VAULT_SECRET_PATH }}/${{ env.REPOSITORY_NAME }}-${{ inputs.ENVIRONMENT }} * ;

      - name: Set environment variables
        shell: bash
        run: |
          # Write secrets to .env file
          echo "${{ steps.import-secrets.outputs }}" > .env.production

#      - name: Write Vault secrets to JSON
#        if: ${{ inputs.SET_ENV == true }}
#        shell: bash
#        run: |
#          echo "${{ toJSON(steps.import-secrets.outputs) }}" >> secrets.json
#
#      - name: Set environment variables
#        shell: bash
#        run: |
#          touch .env.production
#          jq -r 'to_entries[] | .key + "=" + .value' secrets.json >> .env.production

#      - name: Set env if needed
#        if: ${{ inputs.SET_ENV == true }}
#        uses: NationalLibraryOfNorway/tekst-workflows/.github/action/set-env-from-vault@feat/node-workflows

      - name: Run unit tests
        run: npm run test

      - name: Build application
        run: npm run build
